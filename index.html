<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TreinaBet — Pré‑jogo (fictício)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121826; --muted:#8ea0b3; --text:#eef2f7;
      --primary:#00b37e; --primary-2:#0a2e25; --stroke:#1e2a3b; --danger:#e94b4b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:linear-gradient(180deg,#0b0f17,#0a0f16);color:var(--text)}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(120%) blur(8px);background:rgba(11,15,23,.75);border-bottom:1px solid var(--stroke)}
    .wrap{max-width:1040px;margin:0 auto;padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);background:#0c1422;color:var(--text);cursor:pointer}
    .btn:hover{border-color:#2b3a52}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary-2);border-color:#0f4436}
    .btn-danger{background:#1a0e0e;border-color:#4a1a1a}

    main{max-width:1040px;margin:18px auto;padding:0 16px 60px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,var(--card),#0f1624);border:1px solid var(--stroke);border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .teams{font-weight:700}
    .stake{display:flex;align-items:center;gap:8px}
    input[type=number]{width:90px;background:#0b1220;border:1px solid #223048;border-radius:10px;color:var(--text);padding:8px}
    .odds{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .odd{padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:#0c1422;cursor:pointer}
    .odd[disabled]{opacity:.5;cursor:not-allowed}
    .timer{margin-top:8px;font-size:.9rem}
    .list{border-top:1px solid var(--stroke);margin-top:8px;padding-top:8px;max-height:260px;overflow:auto}
    .tag{font-size:.85rem;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke)}
    .tag-won{color:#00e0a4;border-color:#116952;background:#0a2a22}
    .tag-lost{color:#ff9a9a;border-color:#6a2b2b;background:#2a1212}
    .tag-pending{color:#d0d7e1;border-color:#2b3a52;background:#0c1422}
    .tag-void{color:#ffe099;border-color:#6a552b;background:#2a2212}

    /* Modal nick */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#0f1726;border:1px solid var(--stroke);border-radius:16px;padding:18px;max-width:420px;width:92%}
    .modal h3{margin:0 0 6px}
    .field{display:flex;gap:8px;margin-top:8px}
    .field input[type=text]{flex:1;padding:10px;border-radius:12px;border:1px solid #2a3a55;background:#0b1220;color:var(--text)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">TREINABET • PRÉ‑JOGO</div>
        <div id="leagueBadge" class="pill">Série A</div>
      </div>
      <div class="row">
        <div id="saldo" class="pill">Saldo: —</div>
        <button id="btnSettle" class="btn">Verificar resultados</button>
        <button id="btnReset" class="btn btn-danger">Zerar carteira</button>
        <button id="btnNick" class="btn">Trocar nick</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="justify-content:space-between">
        <div class="muted">Arquivo de odds:</div>
        <code id="oddsFile">odds.json</code>
      </div>
      <div class="muted" style="margin-top:6px">Altere <code>DATA_ODDS_URL</code> e <code>DATA_RESULTS_URL</code> no script deste HTML.</div>
    </div>

    <div id="lista" class="grid"></div>

    <div class="card" style="margin-top:14px">
      <strong>Suas apostas</strong>
      <div id="hist" class="list"></div>
    </div>
  </main>

  <!-- Modal de Nick -->
  <div id="modalNick" class="backdrop">
    <div class="modal">
      <h3>Digite seu nick para começar</h3>
      <div class="field">
        <input id="nickInput" type="text" placeholder="Seu nick" maxlength="24" />
        <button id="nickConfirm" class="btn btn-primary">Entrar</button>
      </div>
      <div class="muted" style="margin-top:6px">O nick fica em cookie; banca e apostas ficam no seu navegador.</div>
    </div>
  </div>

<script>
/*********************** CONFIG ***********************/
const DATA_ODDS_URL = "/data/odds-EXEMPLO.json";       // <— aponte para seu arquivo
const DATA_RESULTS_URL = "/data/results-EXEMPLO.json"; // <— mesmo arquivo a semana toda
const CUTOFF_MINUTES_DEFAULT = 2;                       // buffer pré-jogo
/********************* COOKIES/NICK ********************/
function setCookie(name, value, days=365){const d=new Date();d.setTime(d.getTime()+days*24*60*60*1e3);document.cookie=`${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;}
function getCookie(name){const c=name+"=";return decodeURIComponent(document.cookie).split(";").map(s=>s.trim()).find(s=>s.startsWith(c))?.slice(c.length)||null;}
let NICK = getCookie('tb_nick');
function keySaldo(){return `tb_${NICK}_saldo`;}
function keyApostas(){return `tb_${NICK}_bets`;}
function getSaldo(){return Number(localStorage.getItem(keySaldo()) ?? 1000);} 
function setSaldo(v){localStorage.setItem(keySaldo(), String(v)); renderSaldo();}
function renderSaldo(){document.getElementById('saldo').textContent = `Saldo: ${getSaldo().toFixed(2)} créditos`;}
function getBets(){try{return JSON.parse(localStorage.getItem(keyApostas())||'[]')}catch{return []}}
function setBets(a){localStorage.setItem(keyApostas(), JSON.stringify(a)); renderHist();}

/********************* UTILITÁRIOS *********************/
const byId = id => document.getElementById(id);
const el = (tag,cls,txt) => {const e=document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e;}
const norm = s => (s||'').replace(/\s+/g,' ').trim();
function leftMs(startIso, cutoff){return new Date(startIso).getTime() - Date.now() - cutoff*60*1000;}
function fmt(iso){const d=new Date(iso);return d.toLocaleString('pt-BR',{dateStyle:'short', timeStyle:'short'});}

/******************* RENDER DE JOGOS ******************/ 
let CURRENT_ODDS = null;
async function loadOdds(){
  byId('lista').innerHTML = '<div class="muted">Carregando jogos…</div>';
  try{const r=await fetch(DATA_ODDS_URL,{cache:'no-store'}); CURRENT_ODDS = await r.json();}
  catch(e){byId('lista').innerHTML = '<div class="muted">Não consegui carregar o arquivo de odds.</div>'; return;}
  byId('oddsFile').textContent = DATA_ODDS_URL; 
  byId('leagueBadge').textContent = CURRENT_ODDS.league || 'Liga';

  const cutoff = CURRENT_ODDS.cutoffMinutes ?? CUTOFF_MINUTES_DEFAULT;
  const list = byId('lista'); list.innerHTML = '';

  (CURRENT_ODDS.matches||[]).forEach(match => {
    const card = el('div','card');

    // Cabeçalho do jogo
    const top = el('div','row');
    const teams = el('div','teams grow', `${match.home} x ${match.away}`);
    const when = el('div','muted', fmt(match.start) + ' • PRÉ');
    top.append(teams, when);

    // Stake
    const stakeRow = el('div','row');
    const stakeLbl = el('span','muted','Stake');
    const stakeIn = el('input'); stakeIn.type='number'; stakeIn.min='1'; stakeIn.step='1'; stakeIn.value='10'; stakeIn.id = `stake_${match.id}`;
    stakeRow.append(stakeLbl, stakeIn);

    // Odds 1X2
    const odds = el('div','odds');
    const o = match.markets?.['1X2'];
    const btns = [];
    [['home','Casa'],['draw','Empate'],['away','Fora']].forEach(([k,label])=>{
      if(!o||!Number.isFinite(o[k])) return;
      const b = el('button','odd', `${label} @ ${o[k].toFixed(2)}`);
      b.addEventListener('click', () => apostar(match,'1X2',k,o[k],cutoff,b));
      btns.push(b); odds.appendChild(b);
    });

    // Timer
    const timer = el('div','timer muted');
    const tick=()=>{const ms=leftMs(match.start,cutoff); btns.forEach(b=>b.disabled = ms<=0); timer.textContent = ms>0?`Fecha em ${Math.max(0,Math.floor(ms/1000))}s`:'Apostas fechadas';};
    tick(); setInterval(tick,1000);

    card.append(top, stakeRow, odds, timer);
    list.appendChild(card);
  });
}

function apostar(match, market, pick, odd, cutoff, btn){
  if(leftMs(match.start,cutoff) <= 0){alert('Apostas fechadas para este jogo.'); btn.disabled=true; return;}
  const stakeEl = byId(`stake_${match.id}`); const stake = Math.max(1, Math.floor(Number(stakeEl?.value||10)));
  const saldo = getSaldo(); if(stake>saldo){alert('Saldo insuficiente.'); return;}
  setSaldo(saldo - stake);
  const bets = getBets();
  bets.push({ id:`bet_${Date.now()}_${Math.random().toString(16).slice(2)}`, eventId: match.id, desc:`${match.home} x ${match.away}`, start: match.start, market, pick, odd, stake, status:'PENDING', retorno:null });
  setBets(bets);
  alert('Aposta criada!');
}

/******************** HISTÓRICO ************************/ 
function renderHist(){
  const box = byId('hist');
  const a = getBets().slice().reverse();
  if(!a.length){box.innerHTML='<span class="muted">Sem apostas ainda.</span>'; return;}
  box.innerHTML = '';
  for(const b of a){
    const row = el('div','row');
    const left = el('div','grow', `${b.desc} • ${b.market} ${b.pick.toUpperCase()} @ ${b.odd} • stake ${b.stake}`);
    let tag;
    if(b.status==='WON') tag=el('span','tag tag-won','WON');
    else if(b.status==='LOST') tag=el('span','tag tag-lost','LOST');
    else if(b.status==='VOID') tag=el('span','tag tag-void','VOID');
    else tag=el('span','tag tag-pending','PENDING');
    row.append(left, tag);
    box.appendChild(row);
  }
}

/********************* LIQUIDAÇÃO **********************/
async function liquidar(){
  let payload; try{const r=await fetch(DATA_RESULTS_URL,{cache:'no-store'}); if(!r.ok) return; payload=await r.json();}catch{return;}
  const resMap = new Map((payload.results||[]).map(r=>[r.eventId, r]));
  const bets = getBets(); let saldo = getSaldo(); let mudou=false;
  for(const bet of bets){
    if(bet.status!=='PENDING') continue;
    const r = resMap.get(bet.eventId); if(!r || r.status!== 'FINISHING') continue; // só liquida quando FINISHING
    const ph = Number(r.home), pa = Number(r.away);
    let won=false;
    if(bet.market==='1X2'){
      if(ph>pa) won = bet.pick==='home'; else if(ph<pa) won = bet.pick==='away'; else won = bet.pick==='draw';
    }
    if(won){ const ret = Math.floor(bet.stake * bet.odd); saldo += ret; bet.status='WON'; bet.retorno=ret; }
    else { bet.status='LOST'; bet.retorno=0; }
    mudou=true;
  }
  if(mudou){ setSaldo(saldo); setBets(bets); alert('Apostas liquidadas!'); }
}

/******************** NICK / MODAL *********************/
const modal = byId('modalNick');
function ensureNick(){
  if(!NICK){ modal.style.display='flex'; byId('nickInput').focus(); }
  else { if(localStorage.getItem(keySaldo())==null) setSaldo(1000); renderSaldo(); renderHist(); loadOdds(); }
}
byId('nickConfirm').addEventListener('click', ()=>{ const v=norm(byId('nickInput').value).slice(0,24); if(!v) return; NICK=v; setCookie('tb_nick', v); modal.style.display='none'; if(localStorage.getItem(keySaldo())==null) setSaldo(1000); renderSaldo(); renderHist(); loadOdds();});
byId('btnNick').addEventListener('click', ()=>{ modal.style.display='flex'; byId('nickInput').value=''; byId('nickInput').focus(); });

/********************* BOTOES TOP **********************/
byId('btnSettle').addEventListener('click', liquidar);
byId('btnReset').addEventListener('click', ()=>{ if(confirm('Zerar sua carteira e apostas?')){ setSaldo(1000); setBets([]); }});

/*********************** INIT **************************/
ensureNick();
</script>
</body>
</html>
